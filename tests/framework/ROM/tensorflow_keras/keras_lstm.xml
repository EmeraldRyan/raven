<?xml version="1.0" ?>
<Simulation verbosity='debug'>
  <RunInfo>
    <WorkingDir>lstm</WorkingDir>
    <Sequence>
      sample,
      train,
      resample,
      print
    </Sequence>
  </RunInfo>

  <Files>
      <Input name="learnAlphabet">learnAlphabet.py</Input>
  </Files>

  <Models>
    <ExternalModel ModuleToLoad="./learnAlphabet" name="learnAlphabet" subType="">
      <variables>x,y,time,index</variables>
    </ExternalModel>
    <ROM name="modelUnderTest" subType="KerasLSTMClassifier">
      <!-- Common setups -->
      <Features>x</Features>
      <Target>y</Target>
      <loss>categorical_crossentropy</loss>
      <metrics>accuracy</metrics>
      <batch_size>1</batch_size>
      <epochs>10</epochs>
      <plot_model>True</plot_model>
      <validation_split>0.25</validation_split>
      <num_classes>26</num_classes>
      <random_seed>1986</random_seed>
      <optimizerSetting>
        <beta_1>0.9</beta_1>
        <optimizer>Adam</optimizer>
        <beta_2>0.999</beta_2>
        <epsilon>1e-8</epsilon>
        <decay>0.0</decay>
        <lr>0.001</lr>
      </optimizerSetting>
      <!-- Setups for LSTM -->
      <LSTM name="lstm1">
          <activation>tanh</activation>
          <dim_out>32</dim_out>
      </LSTM>
      <LSTM name="lstm2">
          <activation>tanh</activation>
          <dim_out>16</dim_out>
      </LSTM>
      <Dropout name="dropout">
          <rate>0.25</rate>
      </Dropout>
      <Dense name="dense">
          <activation>softmax</activation>
      </Dense>
      <layer_layout>lstm1,lstm2,dropout,dense</layer_layout>
    </ROM>
  </Models>
  
  <Samplers>
    <MonteCarlo name="mcSampler">
      <samplerInit>
        <limit>100</limit>
        <initialSeed>888</initialSeed>
      </samplerInit>
      <variable name="index">
        <distribution>categ</distribution>
      </variable>
    </MonteCarlo>
    <MonteCarlo name="mcTest">
      <samplerInit>
        <limit>20</limit>
        <initialSeed>111</initialSeed>
      </samplerInit>
      <variable name="index">
        <distribution>categ</distribution>
      </variable>
    </MonteCarlo>
  </Samplers>
  
  <Steps>
    <MultiRun name="sample" sleepTime="1e-5">
      <Input class="DataObjects" type="PointSet">dummyIN</Input>
      <Model class="Models" type="ExternalModel">learnAlphabet</Model>
      <Sampler class="Samplers" type="MonteCarlo">mcSampler</Sampler>
      <Output class="DataObjects" type="HistorySet">trainingData</Output>
    </MultiRun>
    <MultiRun name="resample" sleepTime="1e-5">
      <Input class="DataObjects" type="PointSet">dummyIN</Input>
      <Model class="Models" type="ROM">modelUnderTest</Model>
      <Sampler class="Samplers" type="MonteCarlo">mcTest</Sampler>
      <Output class="DataObjects" type="HistorySet">outData</Output>
    </MultiRun>
    <IOStep name="print">
      <Input class="DataObjects" type="HistorySet">trainingData</Input>
      <Input class="DataObjects" type="HistorySet">outData</Input>
      <Output class="OutStreams" type="Print">trainPrint</Output>
      <Output class="OutStreams" type="Print">outPrint</Output>
    </IOStep>
    <RomTrainer name="train">
      <Input class="DataObjects" type="HistorySet">trainingData</Input>
      <Output class="Models" type="ROM">modelUnderTest</Output>
    </RomTrainer>
  </Steps>

  <Distributions>
      <Categorical name="categ">
          <state outcome="1">0.04</state>
          <state outcome="2">0.04</state>
          <state outcome="3">0.04</state>
          <state outcome="4">0.04</state>
          <state outcome="5">0.04</state>
          <state outcome="6">0.04</state>
          <state outcome="7">0.04</state>
          <state outcome="8">0.04</state>
          <state outcome="9">0.04</state>
          <state outcome="10">0.04</state>
          <state outcome="11">0.04</state>
          <state outcome="12">0.04</state>
          <state outcome="13">0.04</state>
          <state outcome="14">0.04</state>
          <state outcome="15">0.04</state>
          <state outcome="16">0.04</state>
          <state outcome="17">0.04</state>
          <state outcome="18">0.04</state>
          <state outcome="19">0.04</state>
          <state outcome="20">0.04</state>
          <state outcome="21">0.06</state>
          <state outcome="22">0.06</state>
          <state outcome="0">0.08</state>
      </Categorical>
  </Distributions>

  <DataObjects>
    <PointSet name="dummyIN">
      <Input>index</Input>
      <Output>OutputPlaceHolder</Output>
    </PointSet>
    <HistorySet name="trainingData">
      <Input>index</Input>
      <Output>x,y</Output>
      <options>
          <pivotParameter>time</pivotParameter>
      </options>
    </HistorySet>
    <HistorySet name="outData">
      <Output>x,y</Output>
      <options>
          <pivotParameter>time</pivotParameter>
      </options>
    </HistorySet>
  </DataObjects>

  <OutStreams>
    <!-- A csv file containing the output of the example -->
    <Print name="outPrint">
      <type>csv</type>
      <source>outData</source>
      <filename>outLSTMClassifier</filename>
    </Print>
    <Print name="trainPrint">
      <type>csv</type>
      <source>trainingData</source>
      <filename>trainDump</filename>
    </Print>
  </OutStreams>
</Simulation>
